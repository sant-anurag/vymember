{% extends "home.html" %}
{% load static %}
{% block main_content %}
<link rel="stylesheet" href="{% static 'css/view_events.css' %}">
<div class="ve-main-container">
    <div class="ve-header-bar">
        <div>
            <h1 class="ve-title"><i class="fas fa-calendar-check"></i> Event Attendance</h1>
            <p class="ve-subtitle">View, filter, and export event attendance records</p>
        </div>
        <button id="download-btn" class="ve-btn ve-btn-accent">
            <i class="fas fa-file-excel"></i> Export Excel
        </button>
    </div>

    <div class="ve-card ve-card-filter">
        <form class="ve-form" method="get">
            <div class="ve-form-group">
                <label for="event_id" class="ve-label">Event</label>
                <select class="ve-select" id="event_id" name="event_id">
                    <option value="">All Events</option>
                    {% for event in events %}
                    <option value="{{ event.id }}" {% if event.id|add:"" == selected_event_id|add:"" %}selected{% endif %}>
                        {{ event.event_name }} ({{ event.event_date }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="ve-form-actions">
                <button type="submit" class="ve-btn ve-btn-primary"><i class="fas fa-filter"></i> Filter</button>
                <a href="{% url 'view_events' %}" class="ve-btn ve-btn-secondary"><i class="fas fa-undo"></i> Reset</a>
            </div>
        </form>
    </div>

    {% if event_summary %}
    <div class="ve-card ve-card-summary">
        <div class="ve-summary-header">
            <i class="fas fa-info-circle"></i> <span>Event Summary</span>
        </div>
        <div class="ve-summary-grid">
            <div><span class="ve-summary-label">Name:</span> {{ event_summary.event_name }}</div>
            <div><span class="ve-summary-label">Date:</span> {{ event_summary.event_date }}</div>
            <div><span class="ve-summary-label">Location:</span> {{ event_summary.location }}</div>
            <div><span class="ve-summary-label">Instructor:</span> {{ event_summary.instructor_name }}</div>
            <div><span class="ve-summary-label">Coordinator:</span> {{ event_summary.coordinator }}</div>
            <div><span class="ve-summary-label">Total Attendance:</span> {{ event_summary.total_attendance }}</div>
            <div class="ve-summary-desc" style="grid-column: 1 / -1;">
                <span class="ve-summary-label">Description:</span>
                <span>{{ event_summary.description|default:"-" }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="ve-card ve-card-table">
        <div class="ve-table-header">
            <i class="fas fa-users"></i> Attendance List
        </div>
        <div class="ve-table-responsive">
            <table class="ve-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Contact</th>
                        <th>Gender</th>
                        <th>Address</th>
                        <th>Attended On</th>
                        <th>New?</th>
                    </tr>
                </thead>
                <tbody>
                    {% for att in attendance_page %}
                    <tr>
                        <td>{{ forloop.counter0|add:attendance_page.start_index }}</td>
                        <td>{{ att.member_name }}</td>
                        <td>{{ att.age|default:"-" }}</td>
                        <td>{{ att.contact_number|default:"-" }}</td>
                        <td>{{ att.gender|default:"-" }}</td>
                        <td>{{ att.address|default:"-" }}</td>
                        <td>{{ att.attended_on|date:"Y-m-d H:i" }}</td>
                        <td>
                            {% if att.is_new_member %}
                                <span class="ve-badge ve-badge-success">Yes</span>
                            {% else %}
                                <span class="ve-badge ve-badge-muted">No</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="ve-table-empty">No attendance records found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <nav class="ve-pagination-nav">
            <ul class="ve-pagination">
                {% if attendance_page.has_previous %}
                <li><a href="?event_id={{ selected_event_id }}&page={{ attendance_page.previous_page_number }}"><i class="fas fa-angle-left"></i></a></li>
                {% else %}
                <li class="disabled"><i class="fas fa-angle-left"></i></li>
                {% endif %}
                {% for num in attendance_page.paginator.page_range %}
                    {% if attendance_page.number == num %}
                        <li class="active">{{ num }}</li>
                    {% elif num > attendance_page.number|add:'-3' and num < attendance_page.number|add:'3' %}
                        <li><a href="?event_id={{ selected_event_id }}&page={{ num }}">{{ num }}</a></li>
                    {% endif %}
                {% endfor %}
                {% if attendance_page.has_next %}
                <li><a href="?event_id={{ selected_event_id }}&page={{ attendance_page.next_page_number }}"><i class="fas fa-angle-right"></i></a></li>
                {% else %}
                <li class="disabled"><i class="fas fa-angle-right"></i></li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
<script>
document.getElementById('download-btn').addEventListener('click', function() {
    window.location.href = "{% url 'download_event_attendance' %}?event_id={{ selected_event_id }}";
});
</script>
{% endblock %}