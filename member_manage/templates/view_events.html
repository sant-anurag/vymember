{% extends "home.html" %}
{% load static %}
{% block main_content %}
<link rel="stylesheet" href="{% static 'css/view_events.css' %}">
<div class="ve-container">
    <!-- Header -->
    <div class="ve-header">
        <h2><i class="fas fa-calendar-alt"></i> Event Attendance Dashboard</h2>
        <button id="download-btn" class="ve-btn ve-btn-success">
            <i class="fas fa-download"></i> Download Excel
        </button>
    </div>

    <!-- Filter Card -->
    <div class="ve-card ve-card-filter">
        <form id="filter-form" class="ve-form" method="get">
            <div class="ve-form-group">
                <label for="event_id" class="ve-label">Select Event</label>
                <select class="ve-select" id="event_id" name="event_id">
                    <option value="">-- All Events --</option>
                    {% for event in events %}
                    <option value="{{ event.id }}" {% if event.id|add:"" == selected_event_id|add:"" %}selected{% endif %}>
                        {{ event.event_name }} ({{ event.event_date }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="ve-form-actions">
                <button type="submit" class="ve-btn ve-btn-primary">Filter</button>
                <a href="{% url 'view_events' %}" class="ve-btn ve-btn-secondary">Reset</a>
            </div>
        </form>
    </div>

    <!-- Event Summary -->
    {% if event_summary %}
    <div class="ve-card ve-card-summary">
        <div class="ve-card-title">
            <i class="fas fa-info-circle"></i> Event Summary
        </div>
        <div class="ve-summary-grid">
            <div>
                <span class="ve-summary-label">Event Name:</span>
                <span>{{ event_summary.event_name }}</span>
            </div>
            <div>
                <span class="ve-summary-label">Date:</span>
                <span>{{ event_summary.event_date }}</span>
            </div>
            <div>
                <span class="ve-summary-label">Location:</span>
                <span>{{ event_summary.location }}</span>
            </div>
            <div>
                <span class="ve-summary-label">Instructor:</span>
                <span>{{ event_summary.instructor_name }}</span>
            </div>
            <div>
                <span class="ve-summary-label">Coordinator:</span>
                <span>{{ event_summary.coordinator }}</span>
            </div>
            <div>
                <span class="ve-summary-label">Total Attendance:</span>
                <span>{{ event_summary.total_attendance }}</span>
            </div>
            <div class="ve-summary-desc" style="grid-column: 1 / -1;">
                <span class="ve-summary-label">Description:</span>
                <span>{{ event_summary.description|default:"-" }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Attendance Table -->
    <div class="ve-card ve-card-table">
        <div class="ve-card-title">
            <i class="fas fa-users"></i> Attendance List
        </div>
        <div class="ve-table-responsive">
            <table class="ve-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Contact</th>
                        <th>Gender</th>
                        <th>Address</th>
                        <th>Attended On</th>
                        <th>New Member?</th>
                    </tr>
                </thead>
                <tbody>
                    {% for att in attendance_page %}
                    <tr>
                        <td>{{ forloop.counter0|add:attendance_page.start_index }}</td>
                        <td>{{ att.member_name }}</td>
                        <td>{{ att.age|default:"-" }}</td>
                        <td>{{ att.contact_number|default:"-" }}</td>
                        <td>{{ att.gender|default:"-" }}</td>
                        <td>{{ att.address|default:"-" }}</td>
                        <td>{{ att.attended_on|date:"Y-m-d H:i" }}</td>
                        <td>
                            {% if att.is_new_member %}
                                <span class="ve-badge ve-badge-success">Yes</span>
                            {% else %}
                                <span class="ve-badge ve-badge-secondary">No</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="ve-table-empty">No attendance records found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Pagination -->
        <nav class="ve-pagination-nav">
            <ul class="ve-pagination">
                {% if attendance_page.has_previous %}
                <li><a href="?event_id={{ selected_event_id }}&page={{ attendance_page.previous_page_number }}">Previous</a></li>
                {% else %}
                <li class="disabled">Previous</li>
                {% endif %}
                {% for num in attendance_page.paginator.page_range %}
                    {% if attendance_page.number == num %}
                        <li class="active">{{ num }}</li>
                    {% elif num > attendance_page.number|add:'-3' and num < attendance_page.number|add:'3' %}
                        <li><a href="?event_id={{ selected_event_id }}&page={{ num }}">{{ num }}</a></li>
                    {% endif %}
                {% endfor %}
                {% if attendance_page.has_next %}
                <li><a href="?event_id={{ selected_event_id }}&page={{ attendance_page.next_page_number }}">Next</a></li>
                {% else %}
                <li class="disabled">Next</li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
document.getElementById('download-btn').addEventListener('click', function() {
    window.location.href = "{% url 'download_event_attendance' %}?event_id={{ selected_event_id }}";
});
</script>
{% endblock %}