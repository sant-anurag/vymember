{% extends "home.html" %}
{% load static %}

{% block main_content %}
<link rel="stylesheet" href="{% static 'css/create_user.css' %}">
<link rel="stylesheet" href="{% static 'css/user_details.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<section class="create-user-section">
  <h2>Create New User</h2>
  {% if message %}
    <div class="status-message {% if success %}success{% else %}error{% endif %}">
      {{ message }}
    </div>
  {% endif %}
  <form class="create-user-form" id="createUserForm" method="post" action="{% url 'create_user' %}">
    {% csrf_token %}
    <div class="form-row">
      <div class="form-group full-width">
        <label for="name">Full Name</label>
        <input type="text" id="name" name="name" required>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="username">Username</label>
        <input type="text" id="username" name="username" required>
      </div>
      <div class="form-group">
        <label for="user_category">User Category</label>
        <select id="user_category" name="user_category" required>
          <option value="">Select Category</option>
          <option value="Standard">Standard</option>
          {% if request.session.is_admin %}
          <option value="Admin">Admin</option>
          {% endif %}
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group full-width">
        <label for="email">Email Address</label>
        <input type="email" id="email" name="email" required>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" required>
      </div>
      <div class="form-group">
        <label for="confirm_password">Confirm Password</label>
        <input type="password" id="confirm_password" name="confirm_password" required>
      </div>
    </div>
    <div class="form-actions">
      <button type="button" id="resetBtn" class="reset-btn">
        <i class="fas fa-undo"></i> Reset
      </button>
      <button type="submit" class="submit-btn">
        <i class="fas fa-user-plus"></i> Create User
      </button>
    </div>
    <div id="statusMessage" class="status-message" style="display: none;"></div>
  </form>
</section>

<section class="user-list-section">
  <h2>Registered Users</h2>
  <div class="section-header">
    <div class="table-actions">
      <div class="search-container">
        <input type="text" id="userSearchInput" placeholder="Search users...">
        <i class="fas fa-search search-icon"></i>
      </div>
      <button id="applyFilterBtn" class="apply-btn">
        <i class="fas fa-filter"></i> Apply Filter
      </button>
      <button id="downloadUserListBtn" class="download-btn">
        <i class="fas fa-download"></i> Download
      </button>
    </div>
  </div>
  <div class="table-container">
    <table id="userTable" class="user-table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Admin Status</th>
          <th>Created On</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>{{ user.username }}</td>
          <td>{{ user.email|default:"N/A" }}</td>
          <td>
            {% if user.is_admin %}
              <span class="badge admin">Admin</span>
            {% else %}
              <span class="badge standard">Standard</span>
            {% endif %}
          </td>
          <td>{{ user.created_on|date:"M d, Y" }}</td>
          <td class="actions-cell">
            <button type="button" class="action-btn view-btn" data-id="{{ user.id }}" title="View User">
              <i class="fas fa-eye"></i>
            </button>
            <button type="button" class="action-btn edit-btn" data-id="{{ user.id }}" title="Edit User">
              <i class="fas fa-edit"></i>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center">No users found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="pagination-container">
    <div class="pagination-info">
      Showing <span id="startRecord">{{ page_obj.start_index }}</span> to <span id="endRecord">{{ page_obj.end_index }}</span> of <span id="totalRecords">{{ page_obj.paginator.count }}</span> users
    </div>
    <div class="pagination">
      {% if page_obj.has_previous %}
      <a href="?page=1" class="pagination-link first">&laquo;</a>
      <a href="?page={{ page_obj.previous_page_number }}" class="pagination-link prev">&lsaquo;</a>
      {% else %}
      <span class="pagination-link disabled first">&laquo;</span>
      <span class="pagination-link disabled prev">&lsaquo;</span>
      {% endif %}
      {% for i in page_obj.paginator.page_range %}
        {% if page_obj.number == i %}
          <span class="pagination-link active">{{ i }}</span>
        {% elif i > page_obj.number|add:"-3" and i < page_obj.number|add:"3" %}
          <a href="?page={{ i }}" class="pagination-link">{{ i }}</a>
        {% endif %}
      {% endfor %}
      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}" class="pagination-link next">&rsaquo;</a>
      <a href="?page={{ page_obj.paginator.num_pages }}" class="pagination-link last">&raquo;</a>
      {% else %}
      <span class="pagination-link disabled next">&rsaquo;</span>
      <span class="pagination-link disabled last">&raquo;</span>
      {% endif %}
    </div>
  </div>
</section>

<!-- User View Modal -->
<div id="userViewOverlay" class="overlay">
  <div class="user-detail-modal pro-modal">
    <div class="modal-header pro-modal-header">
      <h3>User Details</h3>
      <button class="close-btn" id="closeViewModal">&times;</button>
    </div>
    <div class="modal-body pro-modal-body">
      <form class="pro-form-grid">
        <div class="pro-form-group">
          <label for="view_username">Username</label>
          <input type="text" id="view_username" disabled>
        </div>
        <div class="pro-form-group">
          <label for="view_email">Email</label>
          <input type="email" id="view_email" disabled>
        </div>
        <div class="pro-form-group">
          <label for="view_admin_status">Admin Status</label>
          <input type="text" id="view_admin_status" disabled>
        </div>
        <div class="pro-form-group">
          <label for="view_created_on">Created On</label>
          <input type="text" id="view_created_on" disabled>
        </div>
      </form>
    </div>
    <div class="modal-footer pro-modal-footer">
      <button class="modal-btn cancel-btn" id="closeViewBtn">
        <i class="fas fa-times"></i> Close
      </button>
    </div>
  </div>
</div>

<!-- User Edit Modal -->
<div id="userEditOverlay" class="overlay">
  <div class="user-detail-modal pro-modal">
    <div class="modal-header pro-modal-header">
      <h3>Edit User</h3>
      <button class="close-btn" id="closeEditModal">&times;</button>
    </div>
    <div class="modal-body pro-modal-body">
      <div id="editStatusMessage" class="status-message-modal"></div>
      <form id="editUserForm" class="pro-form-grid">
        <input type="hidden" id="edit_user_id">
        <div class="pro-form-group">
          <label for="edit_username">Username</label>
          <input type="text" id="edit_username" required>
        </div>
        <div class="pro-form-group">
          <label for="edit_email">Email</label>
          <input type="email" id="edit_email">
        </div>
        <div class="pro-form-group">
          <label for="edit_admin_status">Admin Status</label>
          <select id="edit_admin_status" required>
            <option value="0">Standard</option>
            <option value="1">Admin</option>
          </select>
        </div>
        <div class="pro-form-group">
          <label for="edit_created_on">Created On</label>
          <input type="text" id="edit_created_on" disabled>
        </div>
        <div class="pro-form-group">
          <label for="edit_password">New Password</label>
          <input type="password" id="edit_password" placeholder="Leave blank to keep current">
        </div>
        <div class="pro-form-group">
          <label for="edit_confirm_password">Confirm New Password</label>
          <input type="password" id="edit_confirm_password">
        </div>
      </form>
    </div>
    <div class="modal-footer pro-modal-footer">
      <button class="modal-btn cancel-btn" id="cancelEditBtn">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button class="modal-btn save-btn" id="saveUserBtn">
        <i class="fas fa-save"></i> Save Changes
      </button>
    </div>
  </div>
</div>
<script src="{% static 'js/create_user.js' %}"></script>
<script src="{% static 'js/user_table.js' %}"></script>
<script src="{% static 'js/user_detail.js' %}"></script>
{% endblock %}