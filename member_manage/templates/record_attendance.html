{% extends "home.html" %}
{% load static %}
{% block main_content %}
<link rel="stylesheet" href="{% static 'css/record_attendance.css' %}">
<section class="attendance-section">
    <h2>Record Attendance</h2>
    {% if message %}
        <div class="status-message">{{ message }}</div>
    {% endif %}
    <!-- Event Filter Row -->
    <form id="eventFilterForm" class="filter-row" method="get" action="{% url 'record_attendance' %}">
        <div class="form-group" style="position: relative; width:400px;">
            <label for="eventFilter">Event<span class="required-asterisk">*</span></label>
            <input type="text" id="eventFilter" placeholder="Type to filter events...min 3 characters required" autocomplete="off" required>
            <input type="hidden" name="event_id" id="eventIdHidden" required>
            <ul id="eventDropdown" class="event-dropdown-list" style="display:none;"></ul>
        </div>
        <button type="submit" class="filter-btn" title="Apply"><i class="fas fa-filter"></i></button>
        <button type="button" class="reset-btn" id="resetFilterBtn" title="Reset"><i class="fas fa-undo"></i></button>
        <button type="button" class="download-btn" id="downloadBtn" title="Download"><i class="fas fa-download"></i></button>
    </form>

    <!-- Event Details Row -->
    {% if selected_event %}
    <div class="event-details-row">
        <input type="text" value="{{ selected_event.event_name }}" readonly placeholder="Event Name" />
        <input type="text" value="{{ selected_event.event_date }}" readonly placeholder="Event Date" />
        <input type="text" value="{{ selected_event.instructor_name }}" readonly placeholder="Instructor" />
        <input type="text" value="{{ selected_event.location }}" readonly placeholder="Location" />
        <input type="text" value="{{ selected_event.state }}" readonly placeholder="State" />
        <input type="text" value="{{ selected_event.city }}" readonly placeholder="City" />
        <input type="text" value="{{ selected_event.country }}" readonly placeholder="Country" />
        <input type="text" value="{{ selected_event.total_attendance }}" readonly placeholder="Total Attendance" />
    </div>
    {% endif %}

    <!-- Attendance Register -->
    {% if selected_event %}
    <form id="attendanceRegisterForm" method="post" action="{% url 'record_attendance' %}?event_id={{ selected_event.id }}">
        {% csrf_token %}
        <div class="attendance-register-header">
            <span>Attendance Register</span>
            <div>
                <button type="button" class="add-member-btn" id="addMemberBtn">Add Member</button>
                <button type="button" class="remove-member-btn" id="removeMemberBtn">Remove Member</button>
            </div>
        </div>
        <div id="attendanceRows">
            <!-- Dynamic member rows will be inserted here -->
        </div>
        <div class="form-actions">
            <button type="submit" class="save-btn">Save</button>
            <button type="button" class="reset-btn" id="resetRegisterBtn">Reset</button>
            <a href="{% url 'dashboard' %}" class="close-btn">Close</a>
        </div>
    </form>
    {% endif %}
</section>
<script src="{% static 'js/record_attendance.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterInput = document.getElementById('eventFilter');
    const dropdown = document.getElementById('eventDropdown');
    const hiddenInput = document.getElementById('eventIdHidden');
    const events = [
        {% for event in events %}
        {id: '{{ event.id }}', name: '{{ event.event_name|escapejs }} ({{ event.event_date|date:"j F, Y" }})'},
        {% endfor %}
    ];
    let filtered = events;

    function showDropdown(list) {
        dropdown.innerHTML = '';
        // Limit to 5 results
        const toShow = list.slice(0, 5);
        if (toShow.length === 0) {
            dropdown.style.display = 'none';
            return;
        }
        toShow.forEach(ev => {
            const li = document.createElement('li');
            li.textContent = ev.name;
            li.dataset.id = ev.id;
            dropdown.appendChild(li);
        });
        dropdown.style.display = 'block';
    }

    filterInput.addEventListener('input', function() {
        const val = filterInput.value.trim().toLowerCase();
        if (val.length === 0) {
            filtered = events;
            showDropdown(filtered);
            hiddenInput.value = '';
            return;
        }
        filtered = events.filter(ev => ev.name.toLowerCase().includes(val));
        showDropdown(filtered);
        hiddenInput.value = '';
    });

    filterInput.addEventListener('focus', function() {
        if (filterInput.value.trim().length === 0) {
            filtered = events;
            showDropdown(filtered);
        } else if (filtered.length > 0) {
            showDropdown(filtered);
        }
    });

    document.addEventListener('click', function(e) {
        if (!dropdown.contains(e.target) && e.target !== filterInput) {
            dropdown.style.display = 'none';
        }
    });

    dropdown.addEventListener('mousedown', function(e) {
        if (e.target.tagName === 'LI') {
            filterInput.value = e.target.textContent;
            hiddenInput.value = e.target.dataset.id;
            dropdown.style.display = 'none';
        }
    });
});
</script>
{% endblock %}

